<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AURA Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; }
        .modal-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 90vw;
            width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">AURA Model Management</h1>
            <a href="/logout" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">Logout</a>
        </div>
        
        <div class="mb-6 text-right">
             <button id="add-new-btn" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-md">Add New Model</button>
        </div>

        <!-- Models List -->
        <div id="models-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Models will be dynamically inserted here -->
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="modal" class="modal-bg hidden">
        <div class="modal">
            <h2 id="modal-title" class="text-2xl font-bold mb-4">Add New Model</h2>
            <form id="model-form" class="space-y-4">
                <input type="hidden" id="model-id">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="name" required class="w-full mt-1 p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="age" class="block text-sm font-medium text-gray-700">Age</label>
                    <input type="number" id="age" required class="w-full mt-1 p-2 border border-gray-300 rounded-md">
                </div>
                 <div>
                    <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="status" required class="w-full mt-1 p-2 border border-gray-300 rounded-md">
                        <option value="Online">Online</option>
                        <option value="Offline">Offline</option>
                    </select>
                </div>
                <div>
                    <label for="bio" class="block text-sm font-medium text-gray-700">Bio</label>
                    <textarea id="bio" rows="3" required class="w-full mt-1 p-2 border border-gray-300 rounded-md"></textarea>
                </div>
                 <div>
                    <label for="profileImage" class="block text-sm font-medium text-gray-700">Profile Image URL</label>
                    <input type="url" id="profileImage" required class="w-full mt-1 p-2 border border-gray-300 rounded-md">
                </div>
                 <div>
                    <label for="videoUrl" class="block text-sm font-medium text-gray-700">Video URL</label>
                    <input type="url" id="videoUrl" required class="w-full mt-1 p-2 border border-gray-300 rounded-md">
                </div>
                 <div>
                    <label for="galleryImages" class="block text-sm font-medium text-gray-700">Gallery Image URLs (one per line)</label>
                    <textarea id="galleryImages" rows="3" class="w-full mt-1 p-2 border border-gray-300 rounded-md"></textarea>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Products (JSON format)</label>
                    <textarea id="products" rows="4" class="w-full mt-1 p-2 border border-gray-300 rounded-md font-mono text-sm"></textarea>
                     <p class="text-xs text-gray-500 mt-1">Example: [{"id":101,"duration":5,"price":29.99,"productHash":"p1","offerHash":"o1"}]</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Reviews (JSON format)</label>
                    <textarea id="reviews" rows="4" class="w-full mt-1 p-2 border border-gray-300 rounded-md font-mono text-sm"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Example: [{"id":"r1","username":"Alex","rating":5,"comment":"Great!","status":"approved"}]</p>
                </div>

                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">Cancel</button>
                    <button type="submit" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded">Save Model</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        const modelsContainer = document.getElementById('models-container');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modelForm = document.getElementById('model-form');
        const addNewBtn = document.getElementById('add-new-btn');
        const cancelBtn = document.getElementById('cancel-btn');

        // --- API Functions ---
        const api = {
            getModels: () => fetch('/api/models').then(res => res.json()),
            addModel: (data) => fetch('/api/models', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(res => res.json()),
            updateModel: (id, data) => fetch(`/api/models/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(res => res.json()),
            deleteModel: (id) => fetch(`/api/models/${id}`, { method: 'DELETE' })
        };

        // --- UI Rendering ---
        function renderModels(models) {
            modelsContainer.innerHTML = '';
            if (!models || models.length === 0) {
                 modelsContainer.innerHTML = `<p class="col-span-full text-center text-gray-500">No models found. Click 'Add New Model' to get started.</p>`;
                 return;
            }
            models.forEach(model => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-md';
                card.innerHTML = `
                    <img src="${model.profileImage}" alt="${model.name}" class="w-full h-48 object-cover rounded-md mb-4">
                    <h3 class="text-xl font-bold">${model.name}, ${model.age}</h3>
                    <p class="text-sm ${model.status === 'Online' ? 'text-green-600' : 'text-gray-500'} font-semibold">${model.status}</p>
                    <p class="text-gray-600 text-sm mt-2 truncate">${model.bio}</p>
                    <div class="flex justify-end gap-2 mt-4">
                        <button class="edit-btn bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded" data-id="${model.id}">Edit</button>
                        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-1 px-3 rounded" data-id="${model.id}">Delete</button>
                    </div>
                `;
                modelsContainer.appendChild(card);
            });
        }

        async function loadModels() {
            try {
                const models = await api.getModels();
                renderModels(models);
            } catch (error) {
                console.error('Failed to load models:', error);
                modelsContainer.innerHTML = '<p class="col-span-full text-center text-red-500">Error loading models. Please check the server logs.</p>';
            }
        }
        
        // --- Modal Handling ---
        function openModal(model = null) {
            modelForm.reset();
            if (model) {
                modalTitle.textContent = 'Edit Model';
                document.getElementById('model-id').value = model.id;
                document.getElementById('name').value = model.name;
                document.getElementById('age').value = model.age;
                document.getElementById('status').value = model.status;
                document.getElementById('bio').value = model.bio;
                document.getElementById('profileImage').value = model.profileImage;
                document.getElementById('videoUrl').value = model.videoUrl;
                document.getElementById('galleryImages').value = (model.galleryImages || []).join('\\n');
                document.getElementById('products').value = JSON.stringify(model.products || [], null, 2);
                document.getElementById('reviews').value = JSON.stringify(model.reviews || [], null, 2);
            } else {
                modalTitle.textContent = 'Add New Model';
                 document.getElementById('model-id').value = '';
            }
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        // --- Event Listeners ---
        addNewBtn.addEventListener('click', () => openModal());
        cancelBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        modelForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('model-id').value;
            
            // Helper to parse JSON fields safely
            const parseJsonField = (fieldId) => {
                try {
                    const content = document.getElementById(fieldId).value.trim();
                    return content ? JSON.parse(content) : [];
                } catch (err) {
                    alert(`Invalid JSON in ${fieldId} field! Please correct it.`);
                    throw new Error(`Invalid JSON in ${fieldId}`);
                }
            };

            let products, reviews;
            try {
                products = parseJsonField('products');
                reviews = parseJsonField('reviews');
            } catch (err) {
                return; // Stop submission if JSON is invalid
            }

            const modelData = {
                name: document.getElementById('name').value,
                age: parseInt(document.getElementById('age').value),
                status: document.getElementById('status').value,
                bio: document.getElementById('bio').value,
                profileImage: document.getElementById('profileImage').value,
                videoUrl: document.getElementById('videoUrl').value,
                galleryImages: document.getElementById('galleryImages').value.split('\\n').map(s => s.trim()).filter(Boolean),
                products: products,
                reviews: reviews
            };

            try {
                if (id) {
                    await api.updateModel(id, modelData);
                } else {
                    await api.addModel(modelData);
                }
                closeModal();
                loadModels();
            } catch(error) {
                 console.error('Failed to save model:', error);
                 alert('Error saving model. Check console for details.');
            }
        });

        modelsContainer.addEventListener('click', async (e) => {
            const target = e.target;
            const id = target.dataset.id;
            
            if (target.classList.contains('edit-btn')) {
                const models = await api.getModels();
                const modelToEdit = models.find(m => m.id === id);
                if (modelToEdit) openModal(modelToEdit);
            }
            
            if (target.classList.contains('delete-btn')) {
                if (confirm('Are you sure you want to delete this model?')) {
                    try {
                        await api.deleteModel(id);
                        loadModels();
                    } catch(error) {
                        console.error('Failed to delete model:', error);
                        alert('Error deleting model.');
                    }
                }
            }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', loadModels);
    </script>
</body>
</html>
